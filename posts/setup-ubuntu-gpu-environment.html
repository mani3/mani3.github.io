<!DOCTYPE html>
<html lang="ja">

<head>
  <!-- Required meta tags always come first -->
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>UbuntuでGPU環境をセットアップ | Lavieleaf
</title>
  <link rel="canonical" href="../posts/setup-ubuntu-gpu-environment.html">

  <link rel="alternate" type="application/rss+xml" href="https://mani3.github.io/feeds/all.rss.xml" title="Full RSS Feed">
  <link rel="alternate" type="application/rss+xml" href="https://mani3.github.io/feeds/category.slug.rss.xml" title="Categories RSS Feed">


  <link rel="stylesheet" href="../theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="../theme/css/font-awesome.min.css">
  <link rel="stylesheet" href="../theme/css/pygments/paraiso-dark.min.css">
  <link rel="stylesheet" href="../theme/css/style.css">
  <link href="https://fonts.googleapis.com/earlyaccess/roundedmplus1c.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/earlyaccess/nicomoji.css" rel="stylesheet" />

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-9947041075020516",
      enable_page_level_ads: true
    });
  </script>


<meta name="description" content="なかなかスタンダードな方法はないのかな">
<script>
  (function(i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function() {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o);
    a.async = 1;
    a.src = g;
    m = s.getElementsByTagName(o)[0];
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-26392156-5', 'auto');
  ga('send', 'pageview');
</script>
</head>

<body>
  <header class="header">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <h1 class="title"><a href="..">Lavieleaf</a></h1>
          <p class="text-muted">おもったことをなんでも書くことろ</p>
          <ul class="list-inline">
            <li class="list-inline-item"><a class="fa fa-github" href="https://github.com/mani3" target="_blank"></a></li>
          </ul>
        </div>
      </div>
    </div>
  </header>

  <div class="main">
    <div class="container">
      <h1>UbuntuでGPU環境をセットアップ
</h1>
      <hr>
<article class="article">
  <header>
    <ul class="list-inline">
      <li class="list-inline-item text-muted" title="2019-10-15T02:46:57+09:00">
        <i class="fa fa-clock-o"></i>
        Tue 15 October 2019
      </li>
      <li class="list-inline-item">
        <i class="fa fa-folder-open-o"></i>
        <a href="../category/deep-learning.html">deep-learning</a>
      </li>
      <li class="list-inline-item">
        <i class="fa fa-user-o"></i>
        <a href="../author/mani3.html">mani3</a>      </li>
      <li class="list-inline-item">
        <i class="fa fa-files-o"></i>
        <a href="../tag/deep-learning.html">#deep-learning</a>      </li>
    </ul>
  </header>
  <div class="content">
    <h2>はじめに</h2>
<p>先日 RTX 2080 Ti を購入したのだけど、MNISTくらいのタスクは実行できるのだけど大きいタスクをやらせると画面にノイズが入って勝手に再起動してしまう現象が起きて苦労した。
結局、初期不良ということで交換対応してもらえた。
そのときにNVIDIAドライバを入れ直したり環境を作ったり壊したりしていて、良さそうなGPU環境のセットアップを決めた。
もう、CUDAのインストールも面倒なのでDockerベースでやることにした。</p>
<ul>
<li>https://github.com/NVIDIA/nvidia-docker</li>
</ul>
<p>上記のリポジトリにnvidiaのコンテナイメージが提供されている。
今後学習もコンテナでやることにしたので、準備をつらつら書いてみる</p>
<h2>準備</h2>
<ul>
<li>Ubuntu 18.04</li>
</ul>
<h2>NVIDIA ドライバのインストール</h2>
<p><a href="https://github.com/NVIDIA/nvidia-docker">NVIDIA/nvidia-docker</a>にもあるが、NVIDIAドライバのインストールは最低限必要になっている。</p>
<p>Ubuntu環境で <code>ubuntu-drivers devices</code> を実行すると推奨ドライバがわかる。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ubuntu-drivers<span class="w"> </span><span class="nv">devices</span>
<span class="o">==</span><span class="w"> </span>/sys/devices/pci0000:00/0000:00:01.0/0000:01:00.0<span class="w"> </span><span class="o">==</span>
modalias<span class="w"> </span>:<span class="w"> </span>pci:v000010DEd00001E07sv000010DEsd00001E07bc03sc00i00
vendor<span class="w">   </span>:<span class="w"> </span>NVIDIA<span class="w"> </span>Corporation
driver<span class="w">   </span>:<span class="w"> </span>nvidia-driver-430<span class="w"> </span>-<span class="w"> </span>distro<span class="w"> </span>non-free<span class="w"> </span>recommended
driver<span class="w">   </span>:<span class="w"> </span>xserver-xorg-video-nouveau<span class="w"> </span>-<span class="w"> </span>distro<span class="w"> </span>free<span class="w"> </span><span class="nb">builtin</span>
</code></pre></div>

<p>とりあえず、自動でインストールして再起動する</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>ubuntu-drivers<span class="w"> </span>autoinstall
$<span class="w"> </span>sudo<span class="w"> </span>reboot<span class="w"> </span>now
</code></pre></div>

<p>再起動後にデバイスが認識しているか <code>nvidia-smi</code> を実行する。一応大丈夫そう。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>nvidia-smi
Sat<span class="w"> </span>Oct<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">00</span>:24:59<span class="w"> </span><span class="m">2019</span>
+-----------------------------------------------------------------------------+
<span class="p">|</span><span class="w"> </span>NVIDIA-SMI<span class="w"> </span><span class="m">430</span>.26<span class="w">       </span>Driver<span class="w"> </span>Version:<span class="w"> </span><span class="m">430</span>.26<span class="w">       </span>CUDA<span class="w"> </span>Version:<span class="w"> </span><span class="m">10</span>.2<span class="w">     </span><span class="p">|</span>
<span class="p">|</span>-------------------------------+----------------------+----------------------+
<span class="p">|</span><span class="w"> </span>GPU<span class="w">  </span>Name<span class="w">        </span>Persistence-M<span class="p">|</span><span class="w"> </span>Bus-Id<span class="w">        </span>Disp.A<span class="w"> </span><span class="p">|</span><span class="w"> </span>Volatile<span class="w"> </span>Uncorr.<span class="w"> </span>ECC<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>Fan<span class="w">  </span>Temp<span class="w">  </span>Perf<span class="w">  </span>Pwr:Usage/Cap<span class="p">|</span><span class="w">         </span>Memory-Usage<span class="w"> </span><span class="p">|</span><span class="w"> </span>GPU-Util<span class="w">  </span>Compute<span class="w"> </span>M.<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="o">===============================</span>+<span class="o">======================</span>+<span class="o">======================</span><span class="p">|</span>
<span class="p">|</span><span class="w">   </span><span class="m">0</span><span class="w">  </span>GeForce<span class="w"> </span>RTX<span class="w"> </span><span class="m">208</span>...<span class="w">  </span>Off<span class="w">  </span><span class="p">|</span><span class="w"> </span><span class="m">00000000</span>:01:00.0<span class="w">  </span>On<span class="w"> </span><span class="p">|</span><span class="w">                  </span>N/A<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">35</span>%<span class="w">   </span>40C<span class="w">    </span>P8<span class="w">    </span>24W<span class="w"> </span>/<span class="w"> </span>260W<span class="w"> </span><span class="p">|</span><span class="w">     </span>99MiB<span class="w"> </span>/<span class="w"> </span>11016MiB<span class="w"> </span><span class="p">|</span><span class="w">      </span><span class="m">0</span>%<span class="w">      </span>Default<span class="w"> </span><span class="p">|</span>
+-------------------------------+----------------------+----------------------+


+-----------------------------------------------------------------------------+
<span class="p">|</span><span class="w"> </span>Processes:<span class="w">                                                       </span>GPU<span class="w"> </span>Memory<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w">  </span>GPU<span class="w">       </span>PID<span class="w">   </span>Type<span class="w">   </span>Process<span class="w"> </span>name<span class="w">                             </span>Usage<span class="w">      </span><span class="p">|</span>
<span class="p">|</span><span class="o">=============================================================================</span><span class="p">|</span>
<span class="p">|</span><span class="w">    </span><span class="m">0</span><span class="w">      </span><span class="m">1078</span><span class="w">      </span>G<span class="w">   </span>/usr/lib/xorg/Xorg<span class="w">                            </span>39MiB<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w">    </span><span class="m">0</span><span class="w">      </span><span class="m">1124</span><span class="w">      </span>G<span class="w">   </span>/usr/bin/gnome-shell<span class="w">                          </span>58MiB<span class="w"> </span><span class="p">|</span>
+——————————————————————————————————————+
</code></pre></div>

<h2>Docker インストール</h2>
<p>ほとんど、公式のインストール方法のまま。現時点の最新は19.03。</p>
<ul>
<li>https://docs.docker.com/install/linux/docker-ce/ubuntu/</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>apt-transport-https<span class="w"> </span>ca-certificates<span class="w"> </span>curl<span class="w"> </span>gnupg-agent<span class="w"> </span>software-properties-common
$<span class="w"> </span>curl<span class="w"> </span>-fsSL<span class="w"> </span>https://download.docker.com/linux/ubuntu/gpg<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>apt-key<span class="w"> </span>add<span class="w"> </span>-
$<span class="w"> </span>sudo<span class="w"> </span>apt-key<span class="w"> </span>fingerprint<span class="w"> </span>0EBFCD88
$<span class="w"> </span>sudo<span class="w"> </span>add-apt-repository<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="s2">&quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu \</span>
<span class="s2">    </span><span class="k">$(</span>lsb_release<span class="w"> </span>-cs<span class="k">)</span><span class="s2"> \</span>
<span class="s2">    stable&quot;</span>
$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>docker-ce<span class="w"> </span>docker-ce-cli<span class="w"> </span>containerd.io
$<span class="w"> </span>sudo<span class="w"> </span>usermod<span class="w"> </span>-aG<span class="w"> </span>docker<span class="w"> </span>&lt;user&gt;
$<span class="w"> </span>sudo<span class="w"> </span>reboot<span class="w"> </span>now
$<span class="w"> </span>docker<span class="w"> </span>version
Client:<span class="w"> </span>Docker<span class="w"> </span>Engine<span class="w"> </span>-<span class="w"> </span>Community
<span class="w"> </span>Version:<span class="w">           </span><span class="m">19</span>.03.3
<span class="w"> </span>API<span class="w"> </span>version:<span class="w">       </span><span class="m">1</span>.40
<span class="w"> </span>Go<span class="w"> </span>version:<span class="w">        </span>go1.12.10
<span class="w"> </span>...

Server:<span class="w"> </span>Docker<span class="w"> </span>Engine<span class="w"> </span>-<span class="w"> </span>Community
<span class="w"> </span>Engine:
<span class="w">  </span>Version:<span class="w">          </span><span class="m">19</span>.03.3
<span class="w">  </span>API<span class="w"> </span>version:<span class="w">      </span><span class="m">1</span>.40<span class="w"> </span><span class="o">(</span>minimum<span class="w"> </span>version<span class="w"> </span><span class="m">1</span>.12<span class="o">)</span>
<span class="w">  </span>Go<span class="w"> </span>version:<span class="w">       </span>go1.12.10
<span class="w"> </span>...
</code></pre></div>

<h2>NVIDIA のコンテナツールのインストール</h2>
<p>これは <a href="https://github.com/NVIDIA/nvidia-docker">NVIDIA/nvidia-docker</a> のまま。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">distribution</span><span class="o">=</span><span class="k">$(</span>.<span class="w"> </span>/etc/os-release<span class="p">;</span><span class="nb">echo</span><span class="w"> </span><span class="nv">$ID$VERSION_ID</span><span class="k">)</span>
$<span class="w"> </span>curl<span class="w"> </span>-s<span class="w"> </span>-L<span class="w"> </span>https://nvidia.github.io/nvidia-docker/gpgkey<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>apt-key<span class="w"> </span>add<span class="w"> </span>-
$<span class="w"> </span>curl<span class="w"> </span>-s<span class="w"> </span>-L<span class="w"> </span>https://nvidia.github.io/nvidia-docker/<span class="nv">$distribution</span>/nvidia-docker.list<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/apt/sources.list.d/nvidia-docker.list
$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>nvidia-container-toolkit
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>docker
$<span class="w"> </span>sudo<span class="w"> </span>reboot<span class="w"> </span>now
$<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>--gpus<span class="w"> </span>all<span class="w"> </span>--rm<span class="w"> </span>nvidia/cuda<span class="w"> </span>nvidia-smi
Unable<span class="w"> </span>to<span class="w"> </span>find<span class="w"> </span>image<span class="w"> </span><span class="s1">&#39;nvidia/cuda:latest&#39;</span><span class="w"> </span>locally
latest:<span class="w"> </span>Pulling<span class="w"> </span>from<span class="w"> </span>nvidia/cuda
35c102085707:<span class="w"> </span>Pull<span class="w"> </span><span class="nb">complete</span>
...
Status:<span class="w"> </span>Downloaded<span class="w"> </span>newer<span class="w"> </span>image<span class="w"> </span><span class="k">for</span><span class="w"> </span>nvidia/cuda:latest
Fri<span class="w"> </span>Oct<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">15</span>:42:40<span class="w"> </span><span class="m">2019</span>
+-----------------------------------------------------------------------------+
<span class="p">|</span><span class="w"> </span>NVIDIA-SMI<span class="w"> </span><span class="m">430</span>.26<span class="w">       </span>Driver<span class="w"> </span>Version:<span class="w"> </span><span class="m">430</span>.26<span class="w">       </span>CUDA<span class="w"> </span>Version:<span class="w"> </span><span class="m">10</span>.2<span class="w">     </span><span class="p">|</span>
<span class="p">|</span>-------------------------------+----------------------+----------------------+
<span class="p">|</span><span class="w"> </span>GPU<span class="w">  </span>Name<span class="w">        </span>Persistence-M<span class="p">|</span><span class="w"> </span>Bus-Id<span class="w">        </span>Disp.A<span class="w"> </span><span class="p">|</span><span class="w"> </span>Volatile<span class="w"> </span>Uncorr.<span class="w"> </span>ECC<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>Fan<span class="w">  </span>Temp<span class="w">  </span>Perf<span class="w">  </span>Pwr:Usage/Cap<span class="p">|</span><span class="w">         </span>Memory-Usage<span class="w"> </span><span class="p">|</span><span class="w"> </span>GPU-Util<span class="w">  </span>Compute<span class="w"> </span>M.<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="o">===============================</span>+<span class="o">======================</span>+<span class="o">======================</span><span class="p">|</span>
<span class="p">|</span><span class="w">   </span><span class="m">0</span><span class="w">  </span>GeForce<span class="w"> </span>RTX<span class="w"> </span><span class="m">208</span>...<span class="w">  </span>Off<span class="w">  </span><span class="p">|</span><span class="w"> </span><span class="m">00000000</span>:01:00.0<span class="w"> </span>Off<span class="w"> </span><span class="p">|</span><span class="w">                  </span>N/A<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">35</span>%<span class="w">   </span>33C<span class="w">    </span>P8<span class="w">    </span>22W<span class="w"> </span>/<span class="w"> </span>260W<span class="w"> </span><span class="p">|</span><span class="w">     </span>26MiB<span class="w"> </span>/<span class="w"> </span>11016MiB<span class="w"> </span><span class="p">|</span><span class="w">      </span><span class="m">0</span>%<span class="w">      </span>Default<span class="w"> </span><span class="p">|</span>
+-------------------------------+----------------------+----------------------+


+-----------------------------------------------------------------------------+
<span class="p">|</span><span class="w"> </span>Processes:<span class="w">                                                       </span>GPU<span class="w"> </span>Memory<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w">  </span>GPU<span class="w">       </span>PID<span class="w">   </span>Type<span class="w">   </span>Process<span class="w"> </span>name<span class="w">                             </span>Usage<span class="w">      </span><span class="p">|</span>
<span class="p">|</span><span class="o">=============================================================================</span><span class="p">|</span>
+-----------------------------------------------------------------------------+
</code></pre></div>

<h2>Dockerfile</h2>
<p>最終的な学習用のコンテナイメージはこんな感じで、これからはTF2.0を使っていこうと思う。
<code>jupyterlab</code> を使えるようにしている。また <code>jupyterlab</code> から Tensorboard が開けるように nodejs 12.xをインストールするようにしてる。</p>
<div class="highlight"><pre><span></span><code><span class="k">FROM</span><span class="w"> </span><span class="s">tensorflow/tensorflow:2.0.0-gpu-py3</span>

<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>--no-install-recommends<span class="w"> </span><span class="se">\</span>
libsm6<span class="w"> </span><span class="se">\</span>
libxext6<span class="w"> </span><span class="se">\</span>
libxrender-dev

<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>clean<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/apt/lists/*

<span class="k">RUN</span><span class="w"> </span>/usr/local/bin/pip<span class="w"> </span>install<span class="w"> </span>-U<span class="w"> </span>pip
<span class="k">RUN</span><span class="w"> </span>/usr/local/bin/pip<span class="w"> </span>--no-cache-dir<span class="w"> </span>install<span class="w"> </span><span class="se">\</span>
wheel<span class="w"> </span><span class="se">\</span>
Pillow<span class="w"> </span><span class="se">\</span>
matplotlib<span class="w"> </span><span class="se">\</span>
numpy<span class="w"> </span><span class="se">\</span>
pandas<span class="w"> </span><span class="se">\</span>
scipy<span class="w"> </span><span class="se">\</span>
sklearn<span class="w"> </span><span class="se">\</span>
tqdm<span class="w"> </span><span class="se">\</span>
argparse<span class="w"> </span><span class="se">\</span>
boto3<span class="w"> </span><span class="se">\</span>
mtcnn<span class="w"> </span><span class="se">\</span>
Cython<span class="w"> </span><span class="se">\</span>
contextlib2<span class="w"> </span><span class="se">\</span>
lxml<span class="w"> </span><span class="se">\</span>
jupyter<span class="w"> </span><span class="se">\</span>
jupyterlab<span class="w"> </span><span class="se">\</span>
easydict

<span class="k">RUN</span><span class="w"> </span>/usr/local/bin/pip<span class="w"> </span>--no-cache-dir<span class="w"> </span>install<span class="w"> </span><span class="se">\</span>
kaggle<span class="w"> </span><span class="se">\</span>
opencv-python

<span class="k">RUN</span><span class="w"> </span>curl<span class="w"> </span>-sL<span class="w"> </span>https://deb.nodesource.com/setup_12.x<span class="w"> </span><span class="p">|</span><span class="w"> </span>bash
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>nodejs
<span class="k">RUN</span><span class="w"> </span>jupyter<span class="w"> </span>labextension<span class="w"> </span>install<span class="w"> </span>jupyterlab_tensorboard
</code></pre></div>

<h3>使い方</h3>
<div class="highlight"><pre><span></span><code>//<span class="w"> </span>イメージを作る
$<span class="w"> </span>docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>tf2<span class="w"> </span>-f<span class="w"> </span>Dockerfile<span class="w"> </span>.

//<span class="w"> </span>jupyterlab<span class="w"> </span>を起動させる
$<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-p<span class="w"> </span><span class="m">8888</span>:8888<span class="w"> </span>-v<span class="w"> </span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>:/docker<span class="w"> </span>--gpus<span class="w"> </span>all<span class="w"> </span>-it<span class="w"> </span>--rm<span class="w"> </span>tf2<span class="w"> </span>jupyter<span class="w"> </span>lab<span class="w"> </span>--ip<span class="o">=</span><span class="m">0</span>.0.0.0<span class="w"> </span>--allow-root
</code></pre></div><script src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</article>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="row">
       <ul class="col-sm-6 list-inline">
          <li class="list-inline-item"><a href="../authors.html">Authors</a></li>
          <li class="list-inline-item"><a href="../archives.html">Archives</a></li>
          <li class="list-inline-item"><a href="../categories.html">Categories</a></li>
          <li class="list-inline-item"><a href="../tags.html">Tags</a></li>
        </ul>
        <p class="col-sm-6 text-sm-right text-muted">
          Generated by <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a> / <a href="https://github.com/nairobilug/pelican-alchemy" target="_blank">&#x2728;</a>
        </p>
      </div>
    </div>
  </footer>
</body>

</html>